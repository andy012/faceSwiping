刷脸加好友文档

[TOC]

# 1 概述

## 1.1 返回码

``` java
//定义的返回码包括code和description两种参数，分别对应返回的errorcode，errormsg参数
public enum  ResponseCode {
    SUCCESS(0,"ok"),
    DATA_ZERO(-1,"没有数据返回"),
    LOGIN_FAIL(-2,"用户名或密码错误"),
    NOT_ALL_SUCCESS(-3,"人脸没有完全加入成功"),
    ALL_NOT_SUCCESS(-4,"人脸添加全部失败");
    private final int code;
    private final String description;
    private ResponseCode(int code, String description){
        this.code=code;
        this.description=description;
    }
    public String getDescription() {
        return description;
    }
    public int getCode() {
        return code;
    }
    @Override
    public String toString() {
        return code + ": " + description;
    }

}

```



## 1.2 数据库设计

* 实体关系模型
  
  ![实体关系模型](file:///Users/andy/Documents/doc/Tensent/diagram.png)


* 数据库脚本

``` sql
USE faceSwiping;

 -- 用户表
CREATE TABLE IF NOT EXISTS `USER` (
  `ID` bigint(20) NOT NULL AUTO_INCREMENT,
  `PASSWORD` varchar(255) DEFAULT NULL COMMENT '密码',
  `USERNAME` varchar(50) DEFAULT NULL COMMENT '用户名为邮箱',
  `ACCOUNT_EXPIRED` TINYINT(1) NOT NULL COMMENT '账户是否到期',
  `ACCOUNT_LOCKED` TINYINT(1) NOT NULL COMMENT '账户是否被锁定',
  `CREDENTIALS_EXPIRED` TINYINT(1) NOT NULL COMMENT '证书是否到期',
  `ACCOUNT_ENABLED` TINYINT(1) NOT NULL COMMENT '账户是否激活',
   PRIMARY KEY (`ID`),
  UNIQUE KEY `USERNAME` (`USERNAME`)
) ENGINE=InnoDB  DEFAULT CHARSET=UTF8 AUTO_INCREMENT=14 ;
-- 用户权限表
CREATE TABLE `USER_AUTHORITY`(
  `USER_ID` BIGINT(20) NOT NULL ,
  `AUTHORITY` VARCHAR(20) NOT NULL ,
  PRIMARY KEY (USER_ID,AUTHORITY)
)ENGINE=InnoDB  DEFAULT CHARSET=UTF8;


-- 用户详细信息表
CREATE TABLE `USER_DETAIL_INFO`(
  `USER_ID` BIGINT(20) NOT NULL ,
  `NICK_NAME`  VARCHAR(50) DEFAULT '',
  `HEAD_IMAGE_KEY` VARCHAR(256) DEFAULT NULL,
  PRIMARY KEY (`USER_ID`)
)ENGINE=InnoDB  DEFAULT CHARSET=UTF8;


-- 用户人脸训练集表
CREATE TABLE `USER_FACE_IMAGES`(
  `ID` bigint(20) NOT NULL AUTO_INCREMENT,
  `USER_ID` BIGINT(20) NOT NULL ,
  `IMAGE_KEY` VARCHAR(256) NOT NULL COMMENT '图片的key',
  `FACE_ID` VARCHAR(50) NOT NULL ,
  `CREATE_TIME`     TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`ID`)
)ENGINE=InnoDB  DEFAULT CHARSET=UTF8;

-- 用户刷脸上传图片表
CREATE TABLE `USER_SWIPING_IMAGES`(
  `ID` bigint(20) NOT NULL AUTO_INCREMENT,
  `USER_ID` BIGINT(20) NOT NULL ,
  `IMAGE_KEY` VARCHAR(256) NOT NULL COMMENT '图片的key',
  `FACE_ID` VARCHAR(50) NOT NULL ,
  `CREATE_TIME`     TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`ID`)
)ENGINE=InnoDB  DEFAULT CHARSET=UTF8;

-- 用户好友关系表
CREATE TABLE `USER_RELATION`(
  `ID` bigint(20) NOT NULL AUTO_INCREMENT,
  `USER_ID` BIGINT(20) NOT NULL COMMENT '用户ID',
  `TARGET_ID` BIGINT(20) NOT NULL COMMENT '好友ID',
  `ACCEPTED` TINYINT(1) NOT NULL COMMENT '是否被接受,0表示未接受,1表示已接受',
  `UPDATE_TIME` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`ID`)
)ENGINE=InnoDB  DEFAULT CHARSET=UTF8;

```

## 1.3 七牛图库的一些参数

``` java

QINIU_ACCESS_KEY=Ve1UX8HxkUbwUV2Qnzc2uCJ0iyWRP2MUTOPZrSRA
QINIU_SECRET_KEY=-jna1k0os4NuCeR8yV8xfJOeEBuuUkzF0kXoOgfY
QINIU_DOMAIN=http://7xozaz.com1.z0.glb.clouddn.com/
QINIU_BUCKET=face
```





# 2、用户权限接口

## 2.1 登录

* 请求路径： /api/login
  
* 请求方式：POST
  
* 参数类型：
  
  ``` json
  contentType:application/json
  content:
  {
      "username": "zhoujielun@face.com",
      "password": "pass"
  }
  ```
  
* 返回值为用户的基本信息(返回json对应的JavaBean为[UserLoginResponse](https://github.com/andy012/faceSwiping/blob/master/src/main/java/com/face/data/user/UserLoginResponse.java))
  
  通过Header的```X-AUTH-TOKEN```参数获取授权的```token```
  
  ``` json
  成功：
  {
      "errorcode": 0,
      "errormsg": "ok",
      "userBaseInfo": {
          "headImageUrl": "http://7xozaz.com1.z0.glb.clouddn.com/null?e=1449650046&token=Ve1UX8HxkUbwUV2Qnzc2uCJ0iyWRP2MUTOPZrSRA:p5Ly3ioP-mEeplig7t_PvfrsHII=",
          "id": 20,
          "nickName": "",
          "userName": "zhoujielun@face.com"
      }
  }
  失败：
  {
      "errorcode": -2,
      "errormsg": "用户名或密码错误",
      "userBaseInfo": {}
  }
  ```

# 3 刷脸接口

## 3.1 添加人脸

用户添加自己的照片，将一组Face加入到一个Person中。注意，一个Face只能被加入到一个Person中。 一个Person最多允许包含20个Face；加入几乎相同的人脸会返回错误。

- 请求路径： /user/faces
  
- 请求方式：PUT
  
- 参数类型：(对应的JavaBean为[UserFacesRequest]())
  
  ``` json
  contentType:application/json
  content:
  {
      "keys": [
          "zhoujielun1.jpg",
          "zhoujielun2.jpg",
          "zhoujielun3.jpg"
      ]
  }
  ```
  
- 返回值(返回json对应的JavaBean为[UserAddFacesResponse](https://github.com/andy012/faceSwiping/blob/master/src/main/java/com/face/data/youtu/UserAddFacesResponse.java))
  
  ``` json
  {
      "count": 3,
      "errorcode": -3,
      "errormsg": "人脸没有完全加入成功",
      "faceResultBeans": [
          {
              "errorcode": 0,
              "errormsg": "ok",
              "key": "zhoujielun1.jpg"
          },
          {
              "errorcode": -1312,
              "errormsg": "",
              "key": "zhoujielun1.jpg"
          },
          {
              "errorcode": 0,
              "errormsg": "ok",
              "key": "zhoujielun2.jpg"
          },
          {
              "errorcode": 0,
              "errormsg": "ok",
              "key": "zhoujielun3.jpg"
          }
      ]
  }
  ```

## 3.2获取用户已经添加的Face

用户添加自己的照片，将一组Face加入到一个Person中。注意，一个Face只能被加入到一个Person中。 一个Person最多允许包含20个Face；加入几乎相同的人脸会返回错误。

- 请求路径： /user/faces
  
- 请求方式：GET
  
- 参数类型：
  
  ``` json
  无
  ```
  
- 返回值，key值及对应的路径；(json对应的JavaBean为[UserFacesResponse](https://github.com/andy012/faceSwiping/blob/master/src/main/java/com/face/data/youtu/UserFacesResponse.java))
  
  ``` json
  {
      "errorcode": 0,
      "errormsg": "ok",
      "facesUrlMap": {
          "zhoujielun1.jpg": "http://7xozaz.com1.z0.glb.clouddn.com/zhoujielun1.jpg?e=1449659316&token=Ve1UX8HxkUbwUV2Qnzc2uCJ0iyWRP2MUTOPZrSRA:oaKqB3ygoN6rK65V-ZXVpKXi6ds=",
          "zhoujielun2.jpg": "http://7xozaz.com1.z0.glb.clouddn.com/zhoujielun2.jpg?e=1449659316&token=Ve1UX8HxkUbwUV2Qnzc2uCJ0iyWRP2MUTOPZrSRA:u18n1EHST2cM0DiPz8DlfpEc1lI=",
          "zhoujielun3.jpg": "http://7xozaz.com1.z0.glb.clouddn.com/zhoujielun3.jpg?e=1449659316&token=Ve1UX8HxkUbwUV2Qnzc2uCJ0iyWRP2MUTOPZrSRA:bZQ9L1bTp-w_mdg5WGvCQqs593A="
      }
  }
  ```

##  